{% extends "base.html" %}
{% block page_content %}
<!-- Navegaci√≥n -->
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container">
        <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Celulares</a></li>
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('dispositivos') }}">Dispositivos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('caja') }}">Caja</a></li>
        </ul>
        <span class="navbar-text">Rol: {{ user.role }} | Usuario: {{ user.username }}</span>
    </div>
</nav>

<h2 class="mb-4">Gesti√≥n de Dispositivos</h2>

<!-- Cards M√©tricas -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #0d6efd !important;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2" style="width: 48px; height: 48px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#0d6efd" viewBox="0 0 16 16">
                                <path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h6zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H5z"/>
                                <path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="small text-muted mb-1">Dispositivos</div>
                        <h4 class="mb-0 fw-bold">{{ cantidad_dispositivos }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #dc3545 !important;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-danger bg-opacity-10 p-2" style="width: 48px; height: 48px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#dc3545" viewBox="0 0 16 16">
                                <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                                <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="small text-muted mb-1">Inversi√≥n Total</div>
                        <h6 class="mb-0 fw-bold" style="font-size: 0.95rem;">{{ inversion_dispositivos|pesos }}</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- B√∫squeda y Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <form method="GET" class="d-flex gap-2 flex-wrap">
            <input type="text" name="search" class="form-control" placeholder="Buscar por modelo, marca o serial" value="{{ search }}" style="flex: 1; min-width: 200px;">
            <select name="tipo" class="form-select" style="max-width: 150px;">
                <option value="">Todos los tipos</option>
                <option value="PC" {% if tipo_filtro == 'PC' %}selected{% endif %}>PC</option>
                <option value="Laptop" {% if tipo_filtro == 'Laptop' %}selected{% endif %}>Laptop</option>
                <option value="Tablet" {% if tipo_filtro == 'Tablet' %}selected{% endif %}>Tablet</option>
                <option value="iPad" {% if tipo_filtro == 'iPad' %}selected{% endif %}>iPad</option>
                <option value="C√°mara" {% if tipo_filtro == 'C√°mara' %}selected{% endif %}>C√°mara</option>
                <option value="Monitor" {% if tipo_filtro == 'Monitor' %}selected{% endif %}>Monitor</option>
            </select>
            <select name="estado" class="form-select" style="max-width: 150px;">
                <option value="">Todos los estados</option>
                <option value="local" {% if estado_filtro == 'local' %}selected{% endif %}>Local</option>
                <option value="Patinado" {% if estado_filtro == 'Patinado' %}selected{% endif %}>Patinado</option>
                <option value="Vendido" {% if estado_filtro == 'Vendido' %}selected{% endif %}>Vendido</option>
                <option value="Servicio T√©cnico" {% if estado_filtro == 'Servicio T√©cnico' %}selected{% endif %}>Servicio T√©cnico</option>
            </select>
            <select name="orden" class="form-select" style="max-width: 150px;">
                <option value="ultimos" {% if orden == 'ultimos' %}selected{% endif %}>√öltimos</option>
                <option value="primeros" {% if orden == 'primeros' %}selected{% endif %}>Primeros</option>
                <option value="marca" {% if orden == 'marca' %}selected{% endif %}>Por Marca</option>
                <option value="tipo" {% if orden == 'tipo' %}selected{% endif %}>Por Tipo</option>
            </select>
            <button type="submit" class="btn btn-outline-secondary">Filtrar</button>
            {% if search or tipo_filtro or estado_filtro or orden != 'ultimos' %}
                <a href="{{ url_for('dispositivos') }}" class="btn btn-outline-danger">Limpiar</a>
            {% endif %}
        </form>
    </div>
    <div class="col-12 text-end mt-3">
        {% if user.role == 'Admin' %}
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addModal">+ Agregar Dispositivo</button>
        {% endif %}
    </div>
</div>

<!-- Modal Facturaci√≥n (Venta con PDF) -->
<div class="modal fade" id="facturaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üìÑ Registrar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="factura-dispositivo-id">
                
                <!-- Info del dispositivo -->
                <div class="alert alert-info mb-3">
                    <strong>Dispositivo:</strong> <span id="factura-dispositivo-info"></span>
                </div>
                
                <!-- Tipo de venta -->
                <h6 class="border-bottom pb-2 mb-3">üí∞ Tipo de Venta</h6>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipo-venta" id="tipo-venta-cliente" value="cliente" checked>
                            <label class="form-check-label fw-bold text-primary" for="tipo-venta-cliente">
                                üë§ Venta Cliente
                            </label>
                        </div>
                        <div class="text-muted small" id="precio-cliente-label">$0</div>
                    </div>
                    <div class="col-6">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipo-venta" id="tipo-venta-patinado" value="patinado">
                            <label class="form-check-label fw-bold text-danger" for="tipo-venta-patinado">
                                üõπ Venta Patinado
                            </label>
                        </div>
                        <div class="text-muted small" id="precio-patinado-label">$0</div>
                    </div>
                </div>
                
                <div class="alert alert-warning py-2" id="precio-seleccionado">
                    <strong>Precio de venta:</strong> <span id="factura-dispositivo-precio" class="fw-bold fs-5">$0</span>
                </div>
                
                <!-- Datos del cliente/tercero -->
                <h6 class="border-bottom pb-2 mb-3" id="label-datos-cliente">üë§ Datos del Cliente (Opcional)</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="factura-cliente-nombre" placeholder="Consumidor Final">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">C√©dula/NIT</label>
                        <input type="text" class="form-control" id="factura-cliente-cedula" placeholder="Ej: 1234567890">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tel√©fono</label>
                        <input type="text" class="form-control" id="factura-cliente-telefono" placeholder="Ej: 300-123-4567">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">M√©todo de Pago</label>
                        <select class="form-select" id="factura-metodo-pago">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Mixto">Mixto</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Direcci√≥n</label>
                    <input type="text" class="form-control" id="factura-cliente-direccion" placeholder="Opcional">
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <div>
                    <button type="button" class="btn btn-outline-success" id="btn-solo-vender">
                        ‚úì Solo Vender
                    </button>
                    <button type="button" class="btn btn-success" id="btn-vender-factura">
                        üìÑ Vender + Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Dispositivo (AJAX) -->
<div class="modal fade" id="editModalAjax" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit-tipo">
                            <option value="PC">PC</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Tablet">Tablet</option>
                            <option value="iPad">iPad</option>
                            <option value="C√°mara">C√°mara</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Teclado">Teclado</option>
                            <option value="Mouse">Mouse</option>
                            <option value="Auriculares">Auriculares</option>
                            <option value="Smartwatch">Smartwatch</option>
                            <option value="Impresora">Impresora</option>
                            <option value="Router">Router</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Marca <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-marca">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Modelo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-modelo">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Serial/C√≥digo</label>
                        <input type="text" class="form-control" id="edit-serial">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Precio Compra <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-precio_compra">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Precio Cliente <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-precio_cliente">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Precio Patinado <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-precio_patinado">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="edit-cantidad" min="1">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Estado <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit-estado">
                            <option value="local">Local</option>
                            <option value="Patinado">Patinado</option>
                            <option value="Vendido">Vendido</option>
                            <option value="Servicio T√©cnico">Servicio T√©cnico</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Especificaciones</label>
                    <textarea class="form-control" id="edit-especificaciones" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notas</label>
                    <textarea class="form-control" id="edit-notas" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-guardar-edicion">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Dispositivo -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Nuevo Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo <span class="text-danger">*</span></label>
                            {{ form.tipo(class="form-select", id="tipo-select") }}
                            <input type="text" class="form-control mt-2" id="tipo-otro" name="tipo_otro" placeholder="Describe el tipo" style="display:none;" value="{{ form.tipo_otro.data or '' }}">
                            <div class="form-text">Si eliges "Otro", escribe el tipo aqu√≠.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Marca <span class="text-danger">*</span></label>
                            {{ form.marca(class="form-control", placeholder="Ej: Dell, Apple, Samsung") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Modelo <span class="text-danger">*</span></label>
                            {{ form.modelo(class="form-control", placeholder="Ej: Inspiron 15") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Serial/C√≥digo</label>
                            {{ form.serial(class="form-control", placeholder="Opcional") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio Compra <span class="text-danger">*</span></label>
                            {{ form.precio_compra(class="form-control", placeholder="Ej: 1500000") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio Cliente <span class="text-danger">*</span></label>
                            {{ form.precio_cliente(class="form-control", placeholder="Ej: 2000000") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio Patinado <span class="text-danger">*</span></label>
                            {{ form.precio_patinado(class="form-control", placeholder="Ej: 1800000") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                            {{ form.cantidad(class="form-control", type="number") }}
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Estado <span class="text-danger">*</span></label>
                            {{ form.estado(class="form-select") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Especificaciones</label>
                        {{ form.especificaciones(class="form-control", rows="3", placeholder="RAM, Almacenamiento, Procesador, etc.") }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        {{ form.notas(class="form-control", rows="2") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Dispositivo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla de Dispositivos -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Tipo</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Serial</th>
                <th>Cant</th>
                <th>P. Compra</th>
                <th>P. Cliente</th>
                <th>P. Patinado</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if dispositivos %}
                {% for d in dispositivos %}
                <tr>
                    <td><span class="badge bg-info">{{ d.tipo }}</span></td>
                    <td>{{ d.marca }}</td>
                    <td>{{ d.modelo }}</td>
                    <td>{{ d.serial or '-' }}</td>
                    <td>{{ d.cantidad }}</td>
                    <td><strong>{{ d.precio_compra|pesos }}</strong></td>
                    <td class="text-primary"><strong>{{ d.precio_cliente|pesos }}</strong></td>
                    <td class="text-danger"><strong>{{ d.precio_patinado|pesos }}</strong></td>
                    <td>
                        <div class="estado-container" data-id="{{ d.id }}">
                            <select class="form-select form-select-sm estado-select-ajax
                                {% if d.estado == 'Patinado' %}bg-danger text-white
                                {% elif d.estado == 'local' %}bg-secondary text-white
                                {% elif d.estado == 'Vendido' %}bg-success text-white
                                {% elif d.estado == 'Servicio T√©cnico' %}bg-warning text-dark
                                {% endif %}" 
                                data-id="{{ d.id }}" data-estado-original="{{ d.estado }}">
                                <option value="local" {% if d.estado == 'local' %}selected{% endif %}>Local</option>
                                <option value="Patinado" {% if d.estado == 'Patinado' %}selected{% endif %}>Patinado</option>
                                <option value="Vendido" {% if d.estado == 'Vendido' %}selected{% endif %}>Vendido</option>
                                <option value="Servicio T√©cnico" {% if d.estado == 'Servicio T√©cnico' %}selected{% endif %}>Servicio T√©cnico</option>
                            </select>
                            <select class="form-select form-select-sm mt-1 tercero-selector-ajax" data-id="{{ d.id }}" {% if d.estado != 'Patinado' %}style="display:none"{% endif %}>
                                <option value="">Selecciona tercero</option>
                                {% for t in terceros %}
                                    <option value="{{ t.id }}" {% if d.tercero_id == t.id %}selected{% endif %}>{{ t.local }} - {{ t.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm d-flex flex-wrap gap-2 acciones-container" role="group" data-id="{{ d.id }}">
                            <button type="button" class="btn btn-outline-warning btn-editar-ajax" data-id="{{ d.id }}">Editar</button>
                            {% if d.estado != 'Vendido' %}
                                <button type="button" class="btn btn-outline-success btn-vender-ajax" data-id="{{ d.id }}">Vendido</button>
                                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#retomaModalDispo{{ d.id }}">Retoma</button>
                            {% else %}
                                <span class="badge bg-success align-self-center vendido-badge">Vendido</span>
                            {% endif %}
                            {% if user.role == 'Admin' %}
                                <button type="button" class="btn btn-outline-danger btn-eliminar-ajax" data-id="{{ d.id }}">Eliminar</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <!-- Modal Plan Retoma para dispositivo -->
                <div class="modal fade" id="retomaModalDispo{{ d.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5>Plan Retoma para {{ d.tipo }} {{ d.marca }} {{ d.modelo }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{{ url_for('retoma_dispositivo', id=d.id) }}">
                                <input type="hidden" name="total_venta" value="{{ (d.precio_cliente * d.cantidad)|float }}">
                                <input type="hidden" name="search" value="{{ search }}">
                                <input type="hidden" name="tipo" value="{{ tipo_filtro }}">
                                <input type="hidden" name="estado" value="{{ estado_filtro }}">
                                <input type="hidden" name="orden" value="{{ orden }}">
                                <div class="modal-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">√çtems recibidos</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRetomaItemDispo('{{ d.id }}')">Agregar √≠tem</button>
                                    </div>

                                    <div class="retoma-items" id="retoma_items_dispo_{{ d.id }}">
                                        <div class="retoma-item border rounded p-2 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="flex-grow-1 pe-2">
                                                    <label class="form-label mb-1">Tipo recibido</label>
                                                    <select name="recibido_tipo[]" class="form-select form-select-sm" onchange="toggleItemTypeDispo(this)">
                                                        <option value="celular" selected>Celular</option>
                                                        <option value="dispositivo">Dispositivo</option>
                                                    </select>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item" onclick="removeRetomaItemDispo(this)" style="display:none;">Quitar</button>
                                            </div>

                                            <div class="retoma-celular">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">IMEI Recibido</label>
                                                        <input type="text" name="imei_recibido[]" class="form-control" placeholder="Ej: 123456789012345">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Modelo Recibido</label>
                                                        <input type="text" name="modelo_recibido[]" class="form-control" placeholder="Ej: iPhone 11">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">GB Recibido</label>
                                                        <select name="gb_recibido[]" class="form-select">
                                                            <option value="">Selecciona</option>
                                                            <option value="64">64GB</option>
                                                            <option value="128">128GB</option>
                                                            <option value="256">256GB</option>
                                                            <option value="512">512GB</option>
                                                            <option value="1TB">1TB</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="retoma-dispositivo" style="display:none;">
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Tipo</label>
                                                        <select name="dispo_tipo[]" class="form-select">
                                                            <option value="PC">PC</option>
                                                            <option value="Laptop">Laptop</option>
                                                            <option value="Tablet">Tablet</option>
                                                            <option value="iPad">iPad</option>
                                                            <option value="C√°mara">C√°mara</option>
                                                            <option value="Monitor">Monitor</option>
                                                            <option value="Teclado">Teclado</option>
                                                            <option value="Mouse">Mouse</option>
                                                            <option value="Auriculares">Auriculares</option>
                                                            <option value="Smartwatch">Smartwatch</option>
                                                            <option value="Impresora">Impresora</option>
                                                            <option value="Router">Router</option>
                                                            <option value="Otro">Otro</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Marca</label>
                                                        <input type="text" name="dispo_marca[]" class="form-control" placeholder="Ej: HP, Samsung">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Modelo</label>
                                                        <input type="text" name="dispo_modelo[]" class="form-control" placeholder="Ej: Elitebook 840">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Serial/C√≥digo</label>
                                                        <input type="text" name="dispo_serial[]" class="form-control" placeholder="Opcional">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Cantidad</label>
                                                        <input type="number" name="dispo_cantidad[]" class="form-control" value="1" min="1">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Notas</label>
                                                        <input type="text" name="dispo_notas[]" class="form-control" placeholder="Estado, accesorios, etc.">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Valor Estimado</label>
                                                    <input type="text" name="valor_estimado[]" class="form-control" placeholder="Ej: 720000" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <template id="retoma_tpl_dispo_{{ d.id }}">
                                        <div class="retoma-item border rounded p-2 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="flex-grow-1 pe-2">
                                                    <label class="form-label mb-1">Tipo recibido</label>
                                                    <select name="recibido_tipo[]" class="form-select form-select-sm" onchange="toggleItemTypeDispo(this)">
                                                        <option value="celular" selected>Celular</option>
                                                        <option value="dispositivo">Dispositivo</option>
                                                    </select>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item" onclick="removeRetomaItemDispo(this)">Quitar</button>
                                            </div>

                                            <div class="retoma-celular">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">IMEI Recibido</label>
                                                        <input type="text" name="imei_recibido[]" class="form-control" placeholder="Ej: 123456789012345">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Modelo Recibido</label>
                                                        <input type="text" name="modelo_recibido[]" class="form-control" placeholder="Ej: iPhone 11">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">GB Recibido</label>
                                                        <select name="gb_recibido[]" class="form-select">
                                                            <option value="">Selecciona</option>
                                                            <option value="64">64GB</option>
                                                            <option value="128">128GB</option>
                                                            <option value="256">256GB</option>
                                                            <option value="512">512GB</option>
                                                            <option value="1TB">1TB</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="retoma-dispositivo" style="display:none;">
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Tipo</label>
                                                        <select name="dispo_tipo[]" class="form-select">
                                                            <option value="PC">PC</option>
                                                            <option value="Laptop">Laptop</option>
                                                            <option value="Tablet">Tablet</option>
                                                            <option value="iPad">iPad</option>
                                                            <option value="C√°mara">C√°mara</option>
                                                            <option value="Monitor">Monitor</option>
                                                            <option value="Teclado">Teclado</option>
                                                            <option value="Mouse">Mouse</option>
                                                            <option value="Auriculares">Auriculares</option>
                                                            <option value="Smartwatch">Smartwatch</option>
                                                            <option value="Impresora">Impresora</option>
                                                            <option value="Router">Router</option>
                                                            <option value="Otro">Otro</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Marca</label>
                                                        <input type="text" name="dispo_marca[]" class="form-control" placeholder="Ej: HP, Samsung">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Modelo</label>
                                                        <input type="text" name="dispo_modelo[]" class="form-control" placeholder="Ej: Elitebook 840">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Serial/C√≥digo</label>
                                                        <input type="text" name="dispo_serial[]" class="form-control" placeholder="Opcional">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Cantidad</label>
                                                        <input type="number" name="dispo_cantidad[]" class="form-control" value="1" min="1">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Notas</label>
                                                        <input type="text" name="dispo_notas[]" class="form-control" placeholder="Estado, accesorios, etc.">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Valor Estimado</label>
                                                    <input type="text" name="valor_estimado[]" class="form-control" placeholder="Ej: 720000" required>
                                                </div>
                                            </div>
                                        </div>
                                    </template>

                                    <div class="row mt-3">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Cash Recibido</label>
                                            <input type="text" name="cash_recibido" class="form-control" placeholder="Ej: 5000000" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nombre Cliente</label>
                                            <input type="text" name="cliente_nombre" class="form-control" placeholder="Ej: Juan P√©rez" required>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <strong>Saldo Pendiente:</strong> Total Venta ({{ (d.precio_cliente * d.cantidad)|pesos }}) - Cash - Suma de valores recibidos.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-info">Confirmar Retoma</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="9" class="text-center py-4">
                        No hay dispositivos registrados.
                        {% if user.role == 'Admin' %}
                            <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#addModal">¬°Agrega uno ahora!</button>
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
    // Mostrar campo "Otro" cuando corresponde
    const tipoSelect = document.getElementById('tipo-select');
    const tipoOtro = document.getElementById('tipo-otro');
    function toggleTipoOtro() {
        if (!tipoSelect || !tipoOtro) return;
        if (tipoSelect.value === 'Otro') {
            tipoOtro.style.display = 'block';
            tipoOtro.required = true;
        } else {
            tipoOtro.style.display = 'none';
            tipoOtro.required = false;
            tipoOtro.value = '';
        }
    }
    if (tipoSelect) {
        tipoSelect.addEventListener('change', toggleTipoOtro);
        toggleTipoOtro();
    }

    // Funci√≥n para formatear precio como pesos colombianos
    function formatearPesos(valor) {
        if (!valor) return '';
        // Remover caracteres no num√©ricos excepto punto y coma
        let num = valor.toString().replace(/[^\d.,]/g, '');
        // Remover puntos y reemplazar coma por punto
        num = num.replace(/\./g, '').replace(',', '.');
        num = parseFloat(num);
        
        if (isNaN(num)) return '';
        
        // Convertir a pesos colombianos
        const entero = Math.floor(num).toString();
        
        let entero_formateado = "";
        for (let i = entero.length - 1, count = 0; i >= 0; i--, count++) {
            if (count > 0 && count % 3 === 0) {
                entero_formateado = "." + entero_formateado;
            }
            entero_formateado = entero.charAt(i) + entero_formateado;
        }
        
        return entero_formateado;
    }
    
    // Formatear precios con pesos mientras se escribe
    document.querySelectorAll('input[name="precio_compra"], input[name="precio_cliente"]').forEach(input => {
        input.addEventListener('input', function() {
            if (this.value) {
                this.value = formatearPesos(this.value);
            }
        });
    });

    // Manejo de estado -> requiere tercero cuando es patinado
    function toggleTerceroSelect(selectEl) {
        const form = selectEl.closest('form');
        const terceroSelect = form ? form.querySelector('.tercero-selector') : null;
        if (!terceroSelect) return;
        if (selectEl.value === 'Patinado') {
            terceroSelect.style.display = 'block';
        } else {
            terceroSelect.value = '';
            terceroSelect.style.display = 'none';
        }
    }

    // === FUNCIONES AJAX PARA DISPOSITIVOS ===
    
    // Mostrar notificaci√≥n toast
    function showToast(message, type = 'success') {
        // Crear toast container si no existe
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        toast.style.cssText = 'min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        toastContainer.appendChild(toast);
        
        // Auto-remove despu√©s de 4 segundos
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 150);
        }, 4000);
    }
    
    // Actualizar clases de color del select de estado
    function updateEstadoSelectColor(selectEl, estado) {
        selectEl.classList.remove('bg-danger', 'bg-secondary', 'bg-success', 'bg-warning', 'text-white', 'text-dark');
        if (estado === 'Patinado') {
            selectEl.classList.add('bg-danger', 'text-white');
        } else if (estado === 'local') {
            selectEl.classList.add('bg-secondary', 'text-white');
        } else if (estado === 'Vendido') {
            selectEl.classList.add('bg-success', 'text-white');
        } else if (estado === 'Servicio T√©cnico') {
            selectEl.classList.add('bg-warning', 'text-dark');
        }
    }
    
    // Cambiar estado via AJAX
    async function cambiarEstadoAjax(id, nuevoEstado, terceroId = null) {
        try {
            const response = await fetch(`/api/dispositivo/cambiar_estado/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nuevo_estado: nuevoEstado,
                    tercero_id: terceroId
                }),
                credentials: 'same-origin'
            });
            
            // Verificar si fue redirigido al login
            if (response.redirected) {
                showToast('Sesi√≥n expirada. Recarga la p√°gina.', 'error');
                return;
            }
            
            // Verificar si la respuesta es HTML (redirect a login)
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                showToast('Error de autenticaci√≥n', 'error');
                const selectEl = document.querySelector(`.estado-select-ajax[data-id="${id}"]`);
                if (selectEl) selectEl.value = selectEl.dataset.estadoOriginal;
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                
                // Actualizar UI
                const selectEl = document.querySelector(`.estado-select-ajax[data-id="${id}"]`);
                if (selectEl) {
                    selectEl.dataset.estadoOriginal = nuevoEstado;
                    updateEstadoSelectColor(selectEl, nuevoEstado);
                }
                
                // Si es vendido, actualizar los botones de acci√≥n
                if (nuevoEstado === 'Vendido') {
                    const accionesContainer = document.querySelector(`.acciones-container[data-id="${id}"]`);
                    if (accionesContainer) {
                        const btnVender = accionesContainer.querySelector('.btn-vender-ajax');
                        const btnRetoma = accionesContainer.querySelector('[data-bs-target^="#retomaModalDispo"]');
                        if (btnVender) btnVender.remove();
                        if (btnRetoma) btnRetoma.remove();
                        
                        // Agregar badge de vendido si no existe
                        if (!accionesContainer.querySelector('.vendido-badge')) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success align-self-center vendido-badge';
                            badge.textContent = 'Vendido';
                            accionesContainer.insertBefore(badge, accionesContainer.querySelector('.btn-eliminar-ajax'));
                        }
                    }
                }
            } else {
                showToast(data.error || 'Error al cambiar estado', 'error');
                // Revertir select al estado original
                const selectEl = document.querySelector(`.estado-select-ajax[data-id="${id}"]`);
                if (selectEl) {
                    selectEl.value = selectEl.dataset.estadoOriginal;
                }
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // === SISTEMA DE FACTURACI√ìN ===
    const facturaModal = new bootstrap.Modal(document.getElementById('facturaModal'));
    let dispositivoActualVenta = null;
    
    // Funci√≥n para actualizar precio seg√∫n tipo de venta
    function actualizarPrecioVenta() {
        if (!dispositivoActualVenta) return;
        
        const tipoVenta = document.querySelector('input[name="tipo-venta"]:checked').value;
        let precio;
        
        if (tipoVenta === 'patinado') {
            precio = dispositivoActualVenta.precio_patinado * dispositivoActualVenta.cantidad;
            document.getElementById('label-datos-cliente').textContent = 'üõπ Datos del Tercero/Patinador (Opcional)';
        } else {
            precio = dispositivoActualVenta.precio_cliente * dispositivoActualVenta.cantidad;
            document.getElementById('label-datos-cliente').textContent = 'üë§ Datos del Cliente (Opcional)';
        }
        
        document.getElementById('factura-dispositivo-precio').textContent = formatearPesosConSigno(precio);
    }
    
    // Event listeners para cambio de tipo de venta
    document.getElementById('tipo-venta-cliente').addEventListener('change', actualizarPrecioVenta);
    document.getElementById('tipo-venta-patinado').addEventListener('change', actualizarPrecioVenta);
    
    // Abrir modal de facturaci√≥n
    async function abrirModalFactura(id) {
        try {
            const response = await fetch(`/api/dispositivo/${id}`, {
                credentials: 'same-origin'
            });
            
            if (response.redirected) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                const d = data.dispositivo;
                dispositivoActualVenta = d;
                
                // Llenar info del dispositivo
                document.getElementById('factura-dispositivo-id').value = d.id;
                document.getElementById('factura-dispositivo-info').textContent = 
                    `${d.tipo} ${d.marca} ${d.modelo} (x${d.cantidad})`;
                
                // Mostrar precios
                document.getElementById('precio-cliente-label').textContent = 
                    formatearPesosConSigno(d.precio_cliente * d.cantidad);
                document.getElementById('precio-patinado-label').textContent = 
                    formatearPesosConSigno(d.precio_patinado * d.cantidad);
                
                // Seleccionar cliente por defecto y actualizar precio
                document.getElementById('tipo-venta-cliente').checked = true;
                actualizarPrecioVenta();
                
                // Limpiar campos del cliente
                document.getElementById('factura-cliente-nombre').value = '';
                document.getElementById('factura-cliente-cedula').value = '';
                document.getElementById('factura-cliente-telefono').value = '';
                document.getElementById('factura-cliente-direccion').value = '';
                document.getElementById('factura-metodo-pago').value = 'Efectivo';
                
                facturaModal.show();
            } else {
                showToast(data.error || 'Error al cargar dispositivo', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Obtener tipo de venta seleccionado
    function obtenerTipoVenta() {
        return document.querySelector('input[name="tipo-venta"]:checked').value;
    }
    
    // Procesar venta (sin factura PDF)
    async function procesarVentaSinFactura() {
        const id = document.getElementById('factura-dispositivo-id').value;
        const tipoVenta = obtenerTipoVenta();
        
        try {
            const response = await fetch(`/api/dispositivo/vender/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tipo_venta: tipoVenta }),
                credentials: 'same-origin'
            });
            
            if (response.redirected) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                facturaModal.hide();
                actualizarUIVendido(id);
            } else {
                showToast(data.error || 'Error al vender', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Procesar venta con factura PDF
    async function procesarVentaConFactura() {
        const id = document.getElementById('factura-dispositivo-id').value;
        const tipoVenta = obtenerTipoVenta();
        
        // Primero registrar la venta
        try {
            const responseVenta = await fetch(`/api/dispositivo/vender/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tipo_venta: tipoVenta }),
                credentials: 'same-origin'
            });
            
            if (responseVenta.redirected) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }
            
            const dataVenta = await responseVenta.json();
            
            if (!dataVenta.success) {
                showToast(dataVenta.error || 'Error al vender', 'error');
                return;
            }
            
            // Ahora generar y descargar el PDF
            const datosCliente = {
                tipo_venta: tipoVenta,
                cliente_nombre: document.getElementById('factura-cliente-nombre').value || 'Consumidor Final',
                cliente_cedula: document.getElementById('factura-cliente-cedula').value,
                cliente_telefono: document.getElementById('factura-cliente-telefono').value,
                cliente_direccion: document.getElementById('factura-cliente-direccion').value,
                metodo_pago: document.getElementById('factura-metodo-pago').value
            };
            
            const responsePDF = await fetch(`/api/dispositivo/factura/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datosCliente),
                credentials: 'same-origin'
            });
            
            if (responsePDF.ok) {
                // Descargar el PDF
                const blob = await responsePDF.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = responsePDF.headers.get('Content-Disposition')?.split('filename=')[1] || `factura_${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                showToast(dataVenta.message + ' - Factura descargada', 'success');
            } else {
                showToast(dataVenta.message + ' (Error al generar PDF)', 'warning');
            }
            
            facturaModal.hide();
            actualizarUIVendido(id);
            
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Actualizar UI despu√©s de vender
    function actualizarUIVendido(id) {
        // Actualizar el select de estado
        const selectEl = document.querySelector(`.estado-select-ajax[data-id="${id}"]`);
        if (selectEl) {
            selectEl.value = 'Vendido';
            selectEl.dataset.estadoOriginal = 'Vendido';
            updateEstadoSelectColor(selectEl, 'Vendido');
        }
        
        // Actualizar botones de acci√≥n
        const accionesContainer = document.querySelector(`.acciones-container[data-id="${id}"]`);
        if (accionesContainer) {
            const btnVender = accionesContainer.querySelector('.btn-vender-ajax');
            const btnRetoma = accionesContainer.querySelector('[data-bs-target^="#retomaModalDispo"]');
            if (btnVender) btnVender.remove();
            if (btnRetoma) btnRetoma.remove();
            
            if (!accionesContainer.querySelector('.vendido-badge')) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-success align-self-center vendido-badge';
                badge.textContent = 'Vendido';
                accionesContainer.insertBefore(badge, accionesContainer.querySelector('.btn-eliminar-ajax'));
            }
        }
        
        // Ocultar selector de tercero
        const terceroSelect = document.querySelector(`.tercero-selector-ajax[data-id="${id}"]`);
        if (terceroSelect) terceroSelect.style.display = 'none';
    }
    
    // Event listeners para modal de factura
    document.getElementById('btn-solo-vender').addEventListener('click', procesarVentaSinFactura);
    document.getElementById('btn-vender-factura').addEventListener('click', procesarVentaConFactura);
    
    // Eliminar dispositivo via AJAX
    async function eliminarDispositivoAjax(id) {
        if (!confirm('¬øEliminar este dispositivo?')) return;
        
        try {
            const response = await fetch(`/api/dispositivo/eliminar/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            // Verificar si fue redirigido al login
            if (response.redirected) {
                showToast('Sesi√≥n expirada. Recarga la p√°gina.', 'error');
                return;
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                showToast('Error de autenticaci√≥n', 'error');
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                
                // Remover la fila de la tabla
                const row = document.querySelector(`.estado-container[data-id="${id}"]`)?.closest('tr');
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                }
            } else {
                showToast(data.error || 'Error al eliminar', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Event listeners para AJAX
    document.querySelectorAll('.estado-select-ajax').forEach(select => {
        select.addEventListener('change', function() {
            const id = this.dataset.id;
            const nuevoEstado = this.value;
            const container = this.closest('.estado-container');
            const terceroSelect = container?.querySelector('.tercero-selector-ajax');
            
            // Mostrar/ocultar selector de tercero
            if (terceroSelect) {
                if (nuevoEstado === 'Patinado') {
                    terceroSelect.style.display = 'block';
                    terceroSelect.focus();
                    return; // No enviar hasta seleccionar tercero
                } else {
                    terceroSelect.style.display = 'none';
                    terceroSelect.value = '';
                }
            }
            
            cambiarEstadoAjax(id, nuevoEstado);
        });
    });
    
    document.querySelectorAll('.tercero-selector-ajax').forEach(select => {
        select.addEventListener('change', function() {
            const id = this.dataset.id;
            const terceroId = this.value;
            const container = this.closest('.estado-container');
            const estadoSelect = container?.querySelector('.estado-select-ajax');
            
            if (estadoSelect?.value === 'Patinado' && terceroId) {
                cambiarEstadoAjax(id, 'Patinado', terceroId);
            }
        });
    });
    
    document.querySelectorAll('.btn-vender-ajax').forEach(btn => {
        btn.addEventListener('click', function() {
            abrirModalFactura(this.dataset.id);
        });
    });
    
    document.querySelectorAll('.btn-eliminar-ajax').forEach(btn => {
        btn.addEventListener('click', function() {
            eliminarDispositivoAjax(this.dataset.id);
        });
    });
    
    // === FUNCIONES PARA EDICI√ìN EN MODAL ===
    const editModal = new bootstrap.Modal(document.getElementById('editModalAjax'));
    
    // Formatear n√∫mero como pesos
    function formatearPesosEdit(num) {
        if (!num && num !== 0) return '';
        const entero = Math.floor(Number(num)).toString();
        let formateado = "";
        for (let i = entero.length - 1, count = 0; i >= 0; i--, count++) {
            if (count > 0 && count % 3 === 0) formateado = "." + formateado;
            formateado = entero.charAt(i) + formateado;
        }
        return formateado;
    }
    
    // Cargar datos del dispositivo en el modal
    async function cargarDispositivoParaEditar(id) {
        try {
            const response = await fetch(`/api/dispositivo/${id}`, {
                credentials: 'same-origin'
            });
            
            if (response.redirected) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                const d = data.dispositivo;
                document.getElementById('edit-id').value = d.id;
                document.getElementById('edit-tipo').value = d.tipo;
                document.getElementById('edit-marca').value = d.marca || '';
                document.getElementById('edit-modelo').value = d.modelo || '';
                document.getElementById('edit-serial').value = d.serial || '';
                document.getElementById('edit-precio_compra').value = formatearPesosEdit(d.precio_compra);
                document.getElementById('edit-precio_cliente').value = formatearPesosEdit(d.precio_cliente);
                document.getElementById('edit-precio_patinado').value = formatearPesosEdit(d.precio_patinado);
                document.getElementById('edit-cantidad').value = d.cantidad || 1;
                document.getElementById('edit-estado').value = d.estado;
                document.getElementById('edit-especificaciones').value = d.especificaciones || '';
                document.getElementById('edit-notas').value = d.notas || '';
                
                editModal.show();
            } else {
                showToast(data.error || 'Error al cargar dispositivo', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Guardar edici√≥n via AJAX
    async function guardarEdicionAjax() {
        const id = document.getElementById('edit-id').value;
        const datos = {
            tipo: document.getElementById('edit-tipo').value,
            marca: document.getElementById('edit-marca').value,
            modelo: document.getElementById('edit-modelo').value,
            serial: document.getElementById('edit-serial').value,
            precio_compra: document.getElementById('edit-precio_compra').value,
            precio_cliente: document.getElementById('edit-precio_cliente').value,
            precio_patinado: document.getElementById('edit-precio_patinado').value,
            cantidad: document.getElementById('edit-cantidad').value,
            estado: document.getElementById('edit-estado').value,
            especificaciones: document.getElementById('edit-especificaciones').value,
            notas: document.getElementById('edit-notas').value
        };
        
        try {
            const response = await fetch(`/api/dispositivo/editar/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos),
                credentials: 'same-origin'
            });
            
            if (response.redirected) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                editModal.hide();
                
                // Actualizar la fila en la tabla
                const row = document.querySelector(`.estado-container[data-id="${id}"]`)?.closest('tr');
                if (row && data.dispositivo) {
                    const d = data.dispositivo;
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 9) {
                        cells[0].innerHTML = `<span class="badge bg-info">${d.tipo}</span>`;
                        cells[1].textContent = d.marca;
                        cells[2].textContent = d.modelo;
                        cells[3].textContent = d.serial || '-';
                        cells[4].textContent = d.cantidad;
                        cells[5].innerHTML = `<strong>${formatearPesosConSigno(d.precio_compra)}</strong>`;
                        cells[6].innerHTML = `<strong class="text-primary">${formatearPesosConSigno(d.precio_cliente)}</strong>`;
                        cells[7].innerHTML = `<strong class="text-danger">${formatearPesosConSigno(d.precio_patinado)}</strong>`;
                        
                        // Actualizar select de estado
                        const estadoSelect = row.querySelector('.estado-select-ajax');
                        if (estadoSelect) {
                            estadoSelect.value = d.estado;
                            estadoSelect.dataset.estadoOriginal = d.estado;
                            updateEstadoSelectColor(estadoSelect, d.estado);
                        }
                    }
                }
            } else {
                showToast(data.error || 'Error al guardar', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
            console.error(error);
        }
    }
    
    // Funci√≥n para formatear pesos con signo $
    function formatearPesosConSigno(num) {
        if (!num && num !== 0) return '$0';
        const entero = Math.floor(Number(num)).toString();
        let formateado = "";
        for (let i = entero.length - 1, count = 0; i >= 0; i--, count++) {
            if (count > 0 && count % 3 === 0) formateado = "." + formateado;
            formateado = entero.charAt(i) + formateado;
        }
        return '$' + formateado;
    }
    
    // Event listeners para edici√≥n
    document.querySelectorAll('.btn-editar-ajax').forEach(btn => {
        btn.addEventListener('click', function() {
            cargarDispositivoParaEditar(this.dataset.id);
        });
    });
    
    document.getElementById('btn-guardar-edicion').addEventListener('click', guardarEdicionAjax);
    
    // Formatear precios en modal de edici√≥n mientras se escribe
    ['edit-precio_compra', 'edit-precio_cliente', 'edit-precio_patinado'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            if (this.value) {
                this.value = formatearPesos(this.value);
            }
        });
    });

    // --- Retoma Dispositivo (similar al de celulares) ---
    function toggleItemTypeDispo(selectEl) {
        const item = selectEl.closest('.retoma-item');
        if (!item) return;
        const tipo = selectEl.value;
        const celDiv = item.querySelector('.retoma-celular');
        const dispDiv = item.querySelector('.retoma-dispositivo');
        if (celDiv) {
            celDiv.style.display = (tipo === 'celular') ? 'block' : 'none';
        }
        if (dispDiv) {
            dispDiv.style.display = (tipo === 'dispositivo') ? 'block' : 'none';
        }
    }

    function refreshRemoveButtonsDispo(container) {
        const items = container.querySelectorAll('.retoma-item');
        items.forEach((el) => {
            const btn = el.querySelector('.btn-remove-item');
            if (btn) btn.style.display = (items.length > 1) ? 'inline-block' : 'none';
            const sel = el.querySelector('select[name="recibido_tipo[]"]');
            if (sel) toggleItemTypeDispo(sel);
        });
    }

    let retomaItemSeqDispo = 0;

    function addRetomaItemDispo(modalId) {
        const tpl = document.getElementById(`retoma_tpl_dispo_${modalId}`);
        const container = document.getElementById(`retoma_items_dispo_${modalId}`);
        if (!tpl || !container) return;
        let clone;
        if (tpl.content && tpl.content.firstElementChild) {
            clone = tpl.content.firstElementChild.cloneNode(true);
        } else {
            const div = document.createElement('div');
            div.innerHTML = tpl.innerHTML.trim();
            clone = div.firstElementChild;
        }
        retomaItemSeqDispo += 1;
        clone.setAttribute('data-item-id', `retoma-dispo-${modalId}-${Date.now()}-${retomaItemSeqDispo}`);
        container.appendChild(clone);

        const valorInput = clone.querySelector('input[name="valor_estimado[]"]');
        if (valorInput) {
            valorInput.addEventListener('input', function() {
                this.value = formatearPesos(this.value);
            });
        }
        refreshRemoveButtonsDispo(container);
    }

    function removeRetomaItemDispo(btn) {
        const item = btn.closest('.retoma-item');
        const container = btn.closest('.retoma-items');
        if (item && container) {
            item.remove();
            refreshRemoveButtonsDispo(container);
        }
    }

    // Inicializar al cargar
    document.querySelectorAll('[id^="retoma_items_dispo_"]').forEach(container => {
        refreshRemoveButtonsDispo(container);
        container.querySelectorAll('select[name="recibido_tipo[]"]').forEach(sel => toggleItemTypeDispo(sel));
    });

    // Exponer funciones en scope global
    window.addRetomaItemDispo = addRetomaItemDispo;
    window.removeRetomaItemDispo = removeRetomaItemDispo;
    window.toggleItemTypeDispo = toggleItemTypeDispo;
</script>
{% endblock %}
